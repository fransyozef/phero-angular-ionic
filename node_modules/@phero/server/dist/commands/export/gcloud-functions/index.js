"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const compileExportToJS_1 = __importDefault(require("../compileExportToJS"));
const generateLibFile_1 = __importDefault(require("./generateLibFile"));
const generateServiceHandlerFile_1 = require("./generateServiceHandlerFile");
const generateServiceIndexFile_1 = __importDefault(require("./generateServiceIndexFile"));
function generateGCloudFunctionsExport(app, metaExportFiles) {
    var _a, _b;
    const packageJson = JSON.parse(metaExportFiles["package.json"]);
    if (!((_a = packageJson === null || packageJson === void 0 ? void 0 : packageJson.dependencies) === null || _a === void 0 ? void 0 : _a["@google-cloud/functions-framework"]) &&
        !((_b = packageJson === null || packageJson === void 0 ? void 0 : packageJson.devDependencies) === null || _b === void 0 ? void 0 : _b["@google-cloud/functions-framework"])) {
        throw new Error(`You should install the dependency "@google-cloud/functions-framework" in your project.`);
    }
    const bundles = app.services.map((service) => ({
        name: service.name,
        files: [
            ...(0, compileExportToJS_1.default)([
                {
                    name: "lib.ts",
                    nodes: (0, generateLibFile_1.default)(),
                    isRoot: true,
                },
                {
                    name: "handler.ts",
                    nodes: (0, generateServiceHandlerFile_1.generateServiceHandlerFile)(service),
                    isRoot: true,
                },
                {
                    name: "index.ts",
                    nodes: (0, generateServiceIndexFile_1.default)(service),
                    isRoot: true,
                },
            ]),
            ...Object.entries(metaExportFiles).map(([name, content]) => ({ name, content })),
        ],
    }));
    return { bundles };
}
exports.default = generateGCloudFunctionsExport;
